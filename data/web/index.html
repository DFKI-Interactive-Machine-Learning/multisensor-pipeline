<!DOCTYPE HTML>
<html>
    <head>
        <title>Flask-SocketIO Test</title>
        <script
                src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
                integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
                crossorigin="anonymous"
        ></script>
        <script
                src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
                integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
                crossorigin="anonymous"
        ></script>
        <script type="text/javascript" charset="utf-8">
            $(document).ready(function() {
                var socket = io();

                socket.on(
                    'connect',
                    function() {
                        socket.emit('event', {data: 'I\'m connected!'});
                    }
                );

                socket.on(
                    'response',
                    function(msg, cb) {
                        $('#log').append(
                            '<br>' + $('<div/>').text(
                                'Received: ' + msg.data
                            ).html()
                        );
                        if (cb)
                            cb();
                    }
                );

                var start_time;
                window.setInterval(
                    function() {
                        start_time = (new Date).getTime();
                        $('#transport').text(socket.io.engine.transport.name);
                        socket.emit('ping');
                    },
                    1000
                );

                var ping_pong_times = [];
                socket.on(
                    'pong',
                    function() {
                        var latency = (new Date).getTime() - start_time;
                        ping_pong_times.push(latency);
                        ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
                        var sum = 0;
                        for (var i = 0; i < ping_pong_times.length; i++)
                            sum += ping_pong_times[i];
                        $('#latency-present').text(Math.round(10 * latency) / 10);
                        $('#latency-minimum').text(Math.min(...ping_pong_times));
                        $('#latency-average').text(Math.round(10 * sum / ping_pong_times.length) / 10);
                        $('#latency-maximum').text(Math.max(...ping_pong_times));
                    }
                );

                $('form#broadcast').submit(function(event) {
                    socket.emit(
                        'broadcast_event',
                        {data: $('#broadcast_data').val()}
                    );
                    return false;
                });
            });
        </script>
    </head>
    <body>
        <h1>Flask-SocketIO Test</h1>
        <p>
            Async mode is: <b>{{ async_mode }}</b><br>
            Current transport is: <b><span id="transport"></span></b><br>
            Roundtrip latency:
            <ul>
                <li>
                    Last one:&nbsp;
                    <span id="latency-present"></span>&nbsp;ms
                </li>
                <li>
                        Minimum over last 30:&nbsp;
                        <span id="latency-minimum"></span>&nbsp;ms
                </li>
                <li>
                    Average over last 30:&nbsp;
                    <span id="latency-average"></span>&nbsp;ms
                </li>
                <li>
                    Maximum over last 30:&nbsp;
                    <span id="latency-maximum"></span>&nbsp;ms
                </li>
            </ul>
        </p>
        <h2>Send:</h2>
        <form id="broadcast" method="POST" action='#'>
            <input type="text" name="broadcast_data" id="broadcast_data" placeholder="Message">
            <input type="submit" value="Broadcast">
        </form>
        <h2>Receive:</h2>
        <div id="log"></div>
    </body>
</html>
